---
phase: 02-frontend-i18n
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/src/i18n/config.ts
  - frontend/src/i18n/request.ts
  - frontend/next.config.ts
  - frontend/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "next-intl is installed and configured"
    - "Locale is read from CAAL_LOCALE cookie with 'en' fallback"
    - "Messages are loaded based on active locale"
    - "NextIntlClientProvider wraps the app"
  artifacts:
    - path: "frontend/src/i18n/config.ts"
      provides: "Locale type and supported locales list"
      exports: ["locales", "Locale", "defaultLocale"]
    - path: "frontend/src/i18n/request.ts"
      provides: "Server-side locale configuration"
      exports: ["default (getRequestConfig)"]
    - path: "frontend/next.config.ts"
      provides: "Next.js config with next-intl plugin"
    - path: "frontend/app/layout.tsx"
      provides: "Root layout with NextIntlClientProvider"
  key_links:
    - from: "frontend/src/i18n/request.ts"
      to: "cookies().get('CAAL_LOCALE')"
      via: "next/headers cookies()"
      pattern: "cookieStore\\.get\\('CAAL_LOCALE'\\)"
    - from: "frontend/app/layout.tsx"
      to: "NextIntlClientProvider"
      via: "next-intl provider import"
      pattern: "NextIntlClientProvider.*messages"
---

<objective>
Set up next-intl infrastructure for the frontend using the "without i18n routing" pattern.

Purpose: Enable internationalization without URL-based locale routing. The locale is determined by a cookie that mirrors the backend language setting, not by URL segments.

Output: Working next-intl setup with locale read from CAAL_LOCALE cookie, ready for message files and component localization.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-frontend-i18n/02-RESEARCH.md
@.planning/phases/02-frontend-i18n/02-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install next-intl and create i18n configuration</name>
  <files>
    frontend/package.json
    frontend/src/i18n/config.ts
    frontend/src/i18n/request.ts
  </files>
  <action>
1. Install next-intl:
   ```bash
   cd frontend && pnpm add next-intl
   ```

2. Create `frontend/src/i18n/config.ts`:
   ```typescript
   export const locales = ['en', 'fr'] as const;
   export type Locale = (typeof locales)[number];
   export const defaultLocale: Locale = 'en';
   ```

3. Create `frontend/src/i18n/request.ts`:
   ```typescript
   import { getRequestConfig } from 'next-intl/server';
   import { cookies } from 'next/headers';
   import { defaultLocale, type Locale, locales } from './config';

   export default getRequestConfig(async () => {
     const cookieStore = await cookies();
     const cookieLocale = cookieStore.get('CAAL_LOCALE')?.value;

     // Validate locale is supported, fallback to default
     const locale: Locale = locales.includes(cookieLocale as Locale)
       ? (cookieLocale as Locale)
       : defaultLocale;

     // Load English as base, overlay with target locale for missing translation fallback
     const englishMessages = (await import('../../messages/en.json')).default;
     const localeMessages = locale !== 'en'
       ? (await import(`../../messages/${locale}.json`)).default
       : {};

     return {
       locale,
       messages: { ...englishMessages, ...localeMessages }
     };
   });
   ```

4. Create empty message files for TypeScript to resolve imports:
   - `frontend/messages/en.json`: `{}`
   - `frontend/messages/fr.json`: `{}`
  </action>
  <verify>
    - `ls frontend/node_modules/next-intl` shows the package is installed
    - `cat frontend/src/i18n/config.ts` shows locale configuration
    - `cat frontend/src/i18n/request.ts` shows cookie-based locale detection
  </verify>
  <done>next-intl installed, i18n config files created with cookie-based locale detection and English fallback</done>
</task>

<task type="auto">
  <name>Task 2: Update Next.js config and root layout</name>
  <files>
    frontend/next.config.ts
    frontend/app/layout.tsx
  </files>
  <action>
1. Update `frontend/next.config.ts` to use next-intl plugin:
   ```typescript
   import createNextIntlPlugin from 'next-intl/plugin';
   import type { NextConfig } from 'next';

   const withNextIntl = createNextIntlPlugin();

   const nextConfig: NextConfig = {
     // Enable standalone output for Docker deployment
     output: 'standalone',
   };

   export default withNextIntl(nextConfig);
   ```

2. Update `frontend/app/layout.tsx` to add NextIntlClientProvider:
   - Import `NextIntlClientProvider` from 'next-intl'
   - Import `getLocale`, `getMessages` from 'next-intl/server'
   - Call `getLocale()` and `getMessages()` in the async component
   - Set `lang={locale}` on the html element (replace hardcoded "en")
   - Wrap children with `<NextIntlClientProvider messages={messages}>...</NextIntlClientProvider>`
   - Provider should wrap around ThemeProvider (i18n outermost, then theme, then children)

   The updated structure should be:
   ```tsx
   import { NextIntlClientProvider } from 'next-intl';
   import { getLocale, getMessages } from 'next-intl/server';
   // ... existing imports ...

   export default async function RootLayout({ children }: RootLayoutProps) {
     const hdrs = await headers();
     const appConfig = await getAppConfig(hdrs);
     const { pageTitle, pageDescription } = appConfig;
     const styles = getStyles(appConfig);

     const locale = await getLocale();
     const messages = await getMessages();

     return (
       <html
         lang={locale}
         suppressHydrationWarning
         // ... existing className ...
       >
         <head>...</head>
         <body className="overflow-x-hidden">
           <NextIntlClientProvider messages={messages}>
             <ThemeProvider ...>
               {children}
             </ThemeProvider>
           </NextIntlClientProvider>
         </body>
       </html>
     );
   }
   ```
  </action>
  <verify>
    - `cat frontend/next.config.ts` shows withNextIntl wrapper
    - `cat frontend/app/layout.tsx` shows NextIntlClientProvider and dynamic locale
    - `cd frontend && pnpm build` completes without errors
  </verify>
  <done>Next.js configured with next-intl plugin, root layout wraps app with NextIntlClientProvider using cookie-based locale</done>
</task>

</tasks>

<verification>
1. `cd frontend && pnpm build` succeeds
2. `cd frontend && pnpm dev` starts without errors
3. Visiting the app shows no console errors related to i18n
4. The html element has `lang="en"` (default since no cookie set yet)
</verification>

<success_criteria>
- next-intl ^4.7.0 installed in frontend/package.json
- src/i18n/config.ts exports locales, Locale type, defaultLocale
- src/i18n/request.ts reads CAAL_LOCALE cookie with English fallback
- next.config.ts uses withNextIntl plugin
- app/layout.tsx wraps app with NextIntlClientProvider
- Build completes without errors
- App renders without i18n-related console errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-frontend-i18n/02-01-SUMMARY.md`
</output>
