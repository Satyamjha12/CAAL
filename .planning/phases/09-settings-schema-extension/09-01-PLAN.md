---
phase: 09-settings-schema-extension
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/caal/settings.py
  - src/caal/webhooks.py
autonomous: true

must_haves:
  truths:
    - "New installations get empty defaults for openai_* and openrouter_* settings"
    - "Existing installations preserve their settings after upgrade"
    - "Malformed URLs are rejected when saving settings"
    - "Empty URLs are accepted (indicates not configured)"
  artifacts:
    - path: "src/caal/settings.py"
      provides: "DEFAULT_SETTINGS with new provider keys"
      contains: "openai_api_key"
    - path: "src/caal/settings.py"
      provides: "URL validation helper"
      contains: "validate_url"
    - path: "src/caal/webhooks.py"
      provides: "Webhook URL validation and secret field handling"
      contains: "openai_base_url"
  key_links:
    - from: "src/caal/webhooks.py"
      to: "src/caal/settings.py"
      via: "validate_url import"
      pattern: "from.*settings.*import.*validate_url"
    - from: "src/caal/webhooks.py"
      to: "update_settings"
      via: "secret_fields includes new API keys"
      pattern: "openai_api_key.*openrouter_api_key"
---

<objective>
Extend the settings schema to support OpenAI-compatible and OpenRouter providers.

Purpose: Phase 8 created the provider implementations and factory, but the settings
keys aren't in DEFAULT_SETTINGS yet. This phase adds the keys so the UI can
configure these providers, and adds URL validation to reject malformed base URLs.

Output:
- DEFAULT_SETTINGS with 5 new keys (openai_*, openrouter_*)
- validate_url() helper function
- Webhook validation for URL settings
- Extended secret_fields and STT coupling for new providers
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-settings-schema-extension/09-RESEARCH.md
@src/caal/settings.py
@src/caal/webhooks.py
@src/caal/llm/providers/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add provider settings keys and URL validation helper</name>
  <files>src/caal/settings.py</files>
  <action>
Add the 5 new provider keys to DEFAULT_SETTINGS after line 76 (after allow_interruptions):

```python
# OpenAI-compatible settings (any OpenAI-compatible server)
"openai_api_key": "",         # Optional API key for authenticated servers
"openai_base_url": "",        # Server URL (empty = not configured)
"openai_model": "",           # Model name (empty = use server default)
# OpenRouter settings (cloud API)
"openrouter_api_key": "",     # OpenRouter API key (required for openrouter provider)
"openrouter_model": "",       # Model name (empty = use default)
```

Use empty strings as defaults to indicate "not configured" in the UI. The factory
in create_provider_from_settings already has fallback values when actually creating
providers.

Add a validate_url() helper function after the imports section (around line 25):

```python
from urllib.parse import urlparse

def validate_url(url: str) -> tuple[bool, str]:
    """Validate URL format for settings.

    Args:
        url: URL string to validate

    Returns:
        Tuple of (is_valid, error_message). Empty error_message if valid.
    """
    if not url or not url.strip():
        return True, ""  # Empty is valid (not configured)

    url = url.strip()

    try:
        parsed = urlparse(url)
    except Exception as e:
        return False, f"Could not parse URL: {e}"

    if not parsed.scheme:
        return False, "URL must include scheme (http:// or https://)"
    if parsed.scheme.lower() not in ("http", "https"):
        return False, f"URL scheme must be http or https, got '{parsed.scheme}'"
    if not parsed.netloc:
        return False, "URL must include host (e.g., localhost:8000)"

    return True, ""
```

Export validate_url in __all__ if one exists, otherwise just make it a public function.
  </action>
  <verify>
Run `uv run python -c "from caal.settings import DEFAULT_SETTINGS, validate_url; print('openai_api_key' in DEFAULT_SETTINGS); print(validate_url('http://localhost:8000'))"` - should print True and (True, '')
  </verify>
  <done>
DEFAULT_SETTINGS contains all 5 new keys with empty string defaults.
validate_url() correctly validates URLs (accepts empty, valid http/https; rejects malformed).
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend webhook validation and provider coupling</name>
  <files>src/caal/webhooks.py</files>
  <action>
1. Import validate_url at the top with other settings imports (around line 50):
   ```python
   from . import settings as settings_module
   from .settings import validate_url
   ```

2. Add new API keys to secret_fields set (around line 442):
   ```python
   secret_fields = {"groq_api_key", "hass_token", "n8n_token", "n8n_api_key",
                    "openai_api_key", "openrouter_api_key"}
   ```

3. Add URL validation before saving settings in update_settings() (after line 445, before the merge loop):
   ```python
   # Validate URL fields
   url_fields = ["openai_base_url", "ollama_host", "hass_host", "n8n_url"]
   for field in url_fields:
       if field in req.settings and req.settings[field]:
           is_valid, error = validate_url(req.settings[field])
           if not is_valid:
               raise HTTPException(status_code=400, detail=f"Invalid {field}: {error}")
   ```

4. Extend the STT/LLM provider coupling logic (around line 453-454) to handle new providers:
   ```python
   # Enforce STT/LLM provider coupling
   if "llm_provider" in req.settings:
       llm = current["llm_provider"]
       # Cloud providers use Groq STT, local providers use Speaches
       if llm in ("groq", "openrouter"):
           current["stt_provider"] = "groq"
       else:  # ollama, openai_compatible
           current["stt_provider"] = "speaches"
   ```

This follows the research recommendation: openrouter is cloud-based (use Groq STT),
openai_compatible is assumed local (use Speaches STT).
  </action>
  <verify>
Run `uv run ruff check src/caal/webhooks.py` - should pass with no errors.
Then test validation:
```bash
uv run python -c "
from caal.webhooks import validate_url
print(validate_url(''))  # Should be (True, '')
print(validate_url('http://localhost:8000'))  # Should be (True, '')
print(validate_url('ftp://server'))  # Should be (False, 'URL scheme must be...')
print(validate_url('not-a-url'))  # Should be (False, 'URL must include scheme...')
"
```
  </verify>
  <done>
- secret_fields includes openai_api_key and openrouter_api_key
- URL validation rejects malformed URLs with 400 error
- STT/LLM coupling handles openai_compatible and openrouter providers
  </done>
</task>

</tasks>

<verification>
After both tasks:

1. **Settings load correctly:**
   ```bash
   uv run python -c "
   from caal.settings import load_settings, DEFAULT_SETTINGS
   s = load_settings()
   keys = ['openai_api_key', 'openai_base_url', 'openai_model',
           'openrouter_api_key', 'openrouter_model']
   for k in keys:
       assert k in DEFAULT_SETTINGS, f'{k} missing from DEFAULT_SETTINGS'
       assert k in s, f'{k} missing from loaded settings'
   print('All 5 new keys present')
   "
   ```

2. **URL validation works:**
   ```bash
   uv run python -c "
   from caal.settings import validate_url
   assert validate_url('')[0] == True, 'Empty should be valid'
   assert validate_url('http://localhost:8000')[0] == True
   assert validate_url('https://api.example.com')[0] == True
   assert validate_url('ftp://server')[0] == False, 'FTP should be invalid'
   assert validate_url('not-a-url')[0] == False, 'No scheme should be invalid'
   print('URL validation works correctly')
   "
   ```

3. **Lint passes:**
   ```bash
   uv run ruff check src/caal/settings.py src/caal/webhooks.py
   ```

4. **Type check passes:**
   ```bash
   uv run mypy src/caal/settings.py src/caal/webhooks.py
   ```
</verification>

<success_criteria>
1. DEFAULT_SETTINGS includes openai_api_key, openai_base_url, openai_model (all empty strings)
2. DEFAULT_SETTINGS includes openrouter_api_key, openrouter_model (all empty strings)
3. validate_url() accepts empty strings and valid http/https URLs
4. validate_url() rejects malformed URLs with descriptive error messages
5. Webhook rejects invalid URLs with HTTP 400
6. New provider API keys are protected as secrets (not cleared on empty save)
7. STT provider correctly couples to new LLM providers
8. All lint and type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-settings-schema-extension/09-01-SUMMARY.md`
</output>
